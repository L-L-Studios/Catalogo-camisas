<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Pedido - VRX</title>
    <link href="https://fonts.cdnfonts.com/css/avenir" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style_notificacion.css">
    <style>
        body {
            font-family: 'Avenir', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .confirmacion-container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .confirmacion-header {
            background: linear-gradient(135deg, #CB2D2D, #BA3C3C);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .confirmacion-logo {
            font-size: 36px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }
        .confirmacion-body {
            padding: 30px;
        }
        .pedido-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .pedido-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .pedido-item:last-child {
            border-bottom: none;
        }
        .btn-confirmar {
            background: linear-gradient(135deg, #CB2D2D, #BA3C3C);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .btn-confirmar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(203, 45, 45, 0.3);
        }
        .btn-confirmar:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #CB2D2D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-message {
            text-align: center;
            padding: 40px;
        }
        .success-icon {
            font-size: 60px;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .error-message {
            text-align: center;
            padding: 40px;
            color: #CB2D2D;
        }
    </style>
</head>
<body>
    <div class="confirmacion-container" id="confirmacionContainer">
        <div class="confirmacion-header">
            <div class="confirmacion-logo">VRX</div>
            <h1>Confirmaci√≥n de Pedido</h1>
        </div>
        
        <div class="confirmacion-body">
            <div id="pedidoInfo">
                <p>Est√°s a punto de confirmar tu pedido en VRX. Revisa los detalles:</p>
                
                <div class="pedido-details" id="detallesPedido">
                    <!-- Los detalles se cargar√°n din√°micamente -->
                </div>
                
                <p style="text-align: center; color: #666; font-size: 14px;">
                    Al confirmar, tu pedido ser√° registrado en nuestro sistema y te contactaremos pronto.
                </p>
                
                <button class="btn-confirmar" id="btnConfirmarPedido">
                    <span id="btnText">Confirmar Pedido</span>
                    <span id="btnLoading" class="loading" style="display:none;"></span>
                </button>
            </div>
            
            <div id="successMessage" style="display:none;" class="success-message">
                <div class="success-icon">‚úì</div>
                <h2>¬°Pedido Confirmado!</h2>
                <p>Tu pedido ha sido registrado exitosamente.</p>
                <p>Te contactaremos dentro de las pr√≥ximas 24 horas.</p>
                <p id="numeroPedido"></p>
                <a href="index.html" id="homeLink" style="color: #CB2D2D; text-decoration: underline;">Volver al inicio</a>
            </div>
            
            <div id="errorMessage" style="display:none;" class="error-message">
                <div style="font-size: 60px;">‚ùå</div>
                <h2>Error en la Confirmaci√≥n</h2>
                <p id="errorText"></p>
                <a href="index.html" id="homeLink" style="color: #CB2D2D; text-decoration: underline;">Volver al inicio</a>
            </div>
        </div>
    </div>

 <!-- REEMPLAZA TODO EL SCRIPT DESPU√âS DE LA L√çNEA 209 HASTA EL FINAL CON ESTO -->

<script src="js/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- AGREGAR EMAILJS PARA EL CORREO -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
    // Inicializar EmailJS
    emailjs.init('3OTktLhSaXJkgGTcX');
</script>

<script>
    // FUNCI√ìN PARA OBTENER LA RUTA BASE (IMPORTANTE PARA GITHUB PAGES)
    function getBaseUrl() {
        // Si estamos en GitHub Pages, la estructura es /nombre-repositorio/
        if (window.location.hostname.includes('github.io')) {
            const pathSegments = window.location.pathname.split('/');
            // Obtener el nombre del repositorio (segundo segmento)
            if (pathSegments.length > 2 && pathSegments[1]) {
                return '/' + pathSegments[1] + '/';
            }
        }
        return '/'; // Para local
    }

    document.addEventListener('DOMContentLoaded', async function() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        
        const btnConfirmar = document.getElementById('btnConfirmarPedido');
        const btnText = document.getElementById('btnText');
        const btnLoading = document.getElementById('btnLoading');
        const detallesPedido = document.getElementById('detallesPedido');
        const pedidoInfo = document.getElementById('pedidoInfo');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const numeroPedido = document.getElementById('numeroPedido');
        
        if (!token) {
            mostrarError('Token de confirmaci√≥n no v√°lido o ha expirado.');
            return;
        }
        
        // Obtener pedido temporal del localStorage
        const pedidoTemporal = JSON.parse(localStorage.getItem('pedido_pendiente_confirmacion'));
        
        if (!pedidoTemporal || pedidoTemporal.token_confirmacion !== token) {
            mostrarError('Token de confirmaci√≥n no v√°lido o ha expirado.');
            return;
        }
        
        // Verificar expiraci√≥n
        const fechaExpiracion = new Date(pedidoTemporal.expira);
        if (fechaExpiracion < new Date()) {
            mostrarError('El token de confirmaci√≥n ha expirado. Por favor, realiza un nuevo pedido.');
            localStorage.removeItem('pedido_pendiente_confirmacion');
            return;
        }
        
        // Mostrar detalles del pedido
        mostrarDetallesPedido(pedidoTemporal);
        
        // Configurar evento de confirmaci√≥n
        btnConfirmar.onclick = async () => {
            btnConfirmar.disabled = true;
            btnText.textContent = 'Confirmando...';
            btnLoading.style.display = 'inline-block';
            
            try {
                // Esperar a que Supabase est√© listo
                if (!window.supabase) {
                    await waitForSupabase();
                }
                
                // Guardar en Supabase
                const numeroPedidoFinal = await guardarPedidoEnSupabase(pedidoTemporal);
                
                // Enviar correo de confirmaci√≥n final
                await enviarCorreoConfirmacionFinal(pedidoTemporal, numeroPedidoFinal);
                
                // Mostrar √©xito
                pedidoInfo.style.display = 'none';
                successMessage.style.display = 'block';
                numeroPedido.textContent = `N√∫mero de pedido: ${numeroPedidoFinal}`;
                
                // Limpiar pedido temporal
                localStorage.removeItem('pedido_pendiente_confirmacion');
                
            } catch (error) {
                console.error('Error confirmando pedido:', error);
                mostrarError('Error al confirmar el pedido. Por favor, intenta nuevamente.');
                btnConfirmar.disabled = false;
                btnText.textContent = 'Confirmar Pedido';
                btnLoading.style.display = 'none';
            }
        };
        
        function mostrarDetallesPedido(pedido) {
            let html = `
                <div class="pedido-item">
                    <strong>Cliente:</strong>
                    <span>${pedido.nombre}</span>
                </div>
                <div class="pedido-item">
                    <strong>Email:</strong>
                    <span>${pedido.email}</span>
                </div>
                <div class="pedido-item">
                    <strong>WhatsApp:</strong>
                    <span>${pedido.whatsapp}</span>
                </div>
                <div class="pedido-item">
                    <strong>Direcci√≥n:</strong>
                    <span>${pedido.direccion}</span>
                </div>
                <div class="pedido-item">
                    <strong>M√©todo de pago:</strong>
                    <span>${pedido.metodo_pago === 'efectivo' ? 'Pago en efectivo' : 'Transferencia'}</span>
                </div>
                <hr style="margin: 15px 0;">
                <h5>Productos:</h5>
            `;
            
            pedido.camisas.forEach((item, index) => {
                html += `
                    <div class="pedido-item">
                        <div>
                            <strong>${item.nombre}</strong><br>
                            <small>Talla: ${item.talla} | Color: ${item.color} | Cantidad: ${item.cantidad}</small>
                            ${item.costo_extra ? `<br><small><em>Extra: ${item.costo_extra}</em></small>` : ''}
                        </div>
                        <div>$${(item.precio * item.cantidad).toFixed(2)}</div>
                    </div>
                `;
            });
            
            html += `
                <hr style="margin: 15px 0;">
                <div class="pedido-item" style="font-size: 18px; font-weight: bold;">
                    <strong>TOTAL:</strong>
                    <span>$${pedido.total} USD</span>
                </div>
            `;
            
            detallesPedido.innerHTML = html;
        }
        
        async function waitForSupabase() {
            return new Promise((resolve) => {
                const check = setInterval(() => {
                    if (window.supabase) {
                        clearInterval(check);
                        resolve();
                    }
                }, 100);
                
                // Timeout despu√©s de 5 segundos
                setTimeout(() => {
                    clearInterval(check);
                    throw new Error('Supabase no se carg√≥');
                }, 5000);
            });
        }
        
        async function guardarPedidoEnSupabase(pedido) {
            if (!window.supabase) {
                throw new Error('Supabase no disponible');
            }
            
            // Generar n√∫mero de pedido final
            const numeroPedidoFinal = 'VRX-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            
            console.log('üìù Guardando pedido en Supabase...');
            
            try {
                // Preparar datos para Supabase
                const datosParaInsertar = {
                    nombre: pedido.nombre || '',
                    email: pedido.email || '',
                    direccion: pedido.direccion || '',
                    whatsapp: pedido.whatsapp || '',
                    metodo_pago: pedido.metodo_pago || 'efectivo',
                    camisas: JSON.stringify(pedido.camisas),
                    total: pedido.total.toString(), // Como string para evitar errores
                    estado: 'pendiente',
                    costo_extra: `Token: ${pedido.token_confirmacion} | N√∫mero: ${numeroPedidoFinal}`,
                };
                
                const { data, error } = await window.supabase
                    .from("pedidos_camisas")
                    .insert([datosParaInsertar])
                    .select();
                
                if (error) {
                    console.error('‚ùå Error Supabase:', error);
                    throw error;
                }
                
                console.log('‚úÖ Pedido guardado:', data);
                return numeroPedidoFinal;
                
            } catch (error) {
                console.error('‚ùå ERROR al guardar pedido:', error);
                throw new Error(`No se pudo guardar el pedido: ${error.message}`);
            }
        }
        
        async function enviarCorreoConfirmacionFinal(pedido, numeroPedidoFinal) {
            try {
                // Formatear productos para el HTML
                const productosHTML = pedido.camisas.map(item => {
                    const subtotal = (item.precio * item.cantidad).toFixed(2);
                    let extraHTML = '';
                    if (item.costo_extra && item.costo_extra.trim() !== '') {
                        extraHTML = `<div style="color: #e65100; font-style: italic; margin-top: 5px;">‚úèÔ∏è Extra: ${item.costo_extra}</div>`;
                    }
                    
                    return `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #CB2D2D;">
                            <div style="font-weight: bold; color: #333; font-size: 16px;">${item.nombre}</div>
                            <div style="color: #666; margin: 8px 0;">
                                <span style="display: inline-block; margin-right: 10px;">üìè Talla: ${item.talla}</span>
                                <span style="display: inline-block; margin-right: 10px;">üé® Color: ${item.color}</span>
                                <span style="display: inline-block;">üì¶ Cantidad: ${item.cantidad}</span>
                            </div>
                            ${extraHTML}
                            <div style="text-align: right; font-weight: bold; color: #CB2D2D; font-size: 16px;">
                                $${subtotal} USD
                            </div>
                        </div>
                    `;
                }).join('');
                
                const ahora = new Date();
                const fecha = ahora.toLocaleDateString('es-ES');
                const hora = ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                const templateParams = {
                    email: pedido.email,
                    order_id: numeroPedidoFinal,
                    customer_name: pedido.nombre || 'Cliente',
                    customer_email: pedido.email || 'No especificado',
                    customer_phone: pedido.whatsapp || 'No especificado',
                    shipping_address: pedido.direccion || 'No especificada',
                    payment_method: pedido.metodo_pago === 'efectivo' ? 'Pago en Efectivo' : pedido.metodo_pago || 'Transferencia',
                    order_date: fecha,
                    order_time: hora,
                    order_items: productosHTML,
                    order_total: `$${pedido.total} USD`,
                    whatsapp_number: pedido.whatsapp || 'No disponible',
                    whatsapp_contact: pedido.whatsapp ? `https://wa.me/${pedido.whatsapp.replace(/\D/g, '')}` : '#',
                    year: new Date().getFullYear().toString()
                };
                
                console.log('üì§ Enviando correo de confirmaci√≥n final...');
                
                const response = await emailjs.send(
                    'pedido_vrx_cliente',
                    'template_x3ow6r4',
                    templateParams
                );
                
                console.log('‚úÖ Correo de confirmaci√≥n final enviado:', response.status);
                
            } catch (error) {
                console.error('‚ùå Error enviando correo final:', error);
                // No lanzamos error aqu√≠ para no interrumpir el flujo principal
            }
        }
        
        function mostrarError(mensaje) {
            pedidoInfo.style.display = 'none';
            errorMessage.style.display = 'block';
            errorText.textContent = mensaje;
            
            // Crear enlace correcto para GitHub Pages
            const baseUrl = getBaseUrl();
            const homeLink = document.querySelector('#errorMessage a');
            if (homeLink) {
                homeLink.href = baseUrl + 'index.html';
            }
        }
        
        // Configurar enlaces para GitHub Pages
        const successLink = document.querySelector('#successMessage a');
        const errorLink = document.querySelector('#errorMessage a');
        const baseUrl = getBaseUrl();
        
        if (successLink) successLink.href = baseUrl + 'index.html';
        if (errorLink) errorLink.href = baseUrl + 'index.html';
    });
</script>